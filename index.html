<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mirindra Chat - Plateforme de communication</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #4361ee;
      --secondary-color: #3f37c9;
      --accent-color: #4895ef;
      --dark-color: #1a1a2e;
      --light-color: #f8f9fa;
      --success-color: #4cc9f0;
      --warning-color: #f72585;
      --gray-color: #6c757d;
      --border-radius: 8px;
      --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f5f7fa;
      color: #333;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    /* Header */
    header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 1.5rem 0;
      box-shadow: var(--box-shadow);
      position: relative;
      z-index: 100;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-family: 'Montserrat', sans-serif;
      font-weight: 700;
      font-size: 1.8rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo i {
      font-size: 1.5rem;
    }

    .user-controls {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--light-color);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      overflow: hidden;
    }

    .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Navigation */
    nav {
      background-color: white;
      box-shadow: var(--box-shadow);
      position: sticky;
      top: 0;
      z-index: 90;
    }

    .nav-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .nav-tabs {
      display: flex;
      list-style: none;
    }

    .nav-tab {
      padding: 1rem 1.5rem;
      cursor: pointer;
      font-weight: 500;
      color: var(--gray-color);
      border-bottom: 3px solid transparent;
      transition: var(--transition);
    }

    .nav-tab:hover {
      color: var(--primary-color);
    }

    .nav-tab.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
    }

    .admin-controls {
      display: flex;
      gap: 10px;
    }

    /* Main Content */
    main {
      padding: 2rem 0;
      min-height: calc(100vh - 200px);
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.5s ease;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Card Styles */
    .card {
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid #eee;
    }

    .card-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--dark-color);
    }

    /* Chat Section */
    #chat-box {
      height: 60vh;
      overflow-y: auto;
      padding: 1rem;
      background-color: #f8f9fa;
      border-radius: var(--border-radius);
      margin-bottom: 1rem;
      border: 1px solid #e9ecef;
    }

    .message {
      margin-bottom: 1rem;
      padding: 0.75rem 1rem;
      border-radius: var(--border-radius);
      background-color: white;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      max-width: 80%;
      position: relative;
    }

    .message.user {
      margin-left: auto;
      background-color: var(--primary-color);
      color: white;
    }

    .message-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      font-size: 0.85rem;
    }

    .message-user {
      font-weight: 600;
    }

    .message-time {
      opacity: 0.7;
    }

    .message-content {
      word-wrap: break-word;
    }

    .message-media {
      margin-top: 0.5rem;
      max-width: 100%;
      border-radius: var(--border-radius);
    }

    /* Forms */
    .form-group {
      margin-bottom: 1rem;
    }

    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .form-control {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ced4da;
      border-radius: var(--border-radius);
      font-size: 1rem;
      transition: var(--transition);
    }

    .form-control:focus {
      border-color: var(--primary-color);
      outline: none;
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }

    .input-group {
      display: flex;
      gap: 10px;
    }

    .input-group .form-control {
      flex: 1;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: var(--border-radius);
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      gap: 8px;
    }

    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background-color: var(--secondary-color);
    }

    .btn-secondary {
      background-color: var(--gray-color);
      color: white;
    }

    .btn-secondary:hover {
      background-color: #5a6268;
    }

    .btn-success {
      background-color: var(--success-color);
      color: white;
    }

    .btn-success:hover {
      background-color: #3aa8d4;
    }

    .btn-danger {
      background-color: var(--warning-color);
      color: white;
    }

    .btn-danger:hover {
      background-color: #d61a6b;
    }

    .btn-outline {
      background-color: transparent;
      border: 1px solid var(--primary-color);
      color: var(--primary-color);
    }

    .btn-outline:hover {
      background-color: var(--primary-color);
      color: white;
    }

    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }

    /* Auth Buttons */
    .auth-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .auth-btn {
      flex: 1;
      min-width: 200px;
    }

    .auth-btn.google {
      background-color: #4285F4;
    }

    .auth-btn.facebook {
      background-color: #3b5998;
    }

    .auth-btn.instagram {
      background: linear-gradient(45deg, #405DE6, #5851DB, #833AB4, #C13584, #E1306C, #FD1D1D);
    }

    /* Gallery */
    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-top: 1.5rem;
    }

    .media-item {
      position: relative;
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: var(--box-shadow);
      transition: var(--transition);
    }

    .media-item:hover {
      transform: translateY(-5px);
    }

    .media-item img, .media-item video {
      width: 100%;
      height: 200px;
      object-fit: cover;
      display: block;
    }

    .media-info {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 0.5rem;
      font-size: 0.85rem;
    }

    .media-user {
      font-weight: 600;
    }

    /* User Management */
    .users-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    .users-table th, .users-table td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    .users-table th {
      background-color: #f8f9fa;
      font-weight: 600;
    }

    .users-table tr:hover {
      background-color: #f8f9fa;
    }

    .user-role {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      background-color: #e9ecef;
      color: #495057;
    }

    .user-role.admin {
      background-color: #d1e7dd;
      color: #0f5132;
    }

    .user-role.moderator {
      background-color: #fff3cd;
      color: #664d03;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: white;
      border-radius: var(--border-radius);
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      animation: modalFadeIn 0.3s ease;
    }

    @keyframes modalFadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--gray-color);
    }

    .modal-body {
      padding: 1.5rem;
    }

    .modal-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header-content, .nav-container {
        flex-direction: column;
        gap: 1rem;
      }

      .nav-tabs {
        flex-wrap: wrap;
        justify-content: center;
      }

      .auth-buttons {
        flex-direction: column;
      }

      .auth-btn {
        width: 100%;
      }

      .input-group {
        flex-direction: column;
      }
    }

    /* Animations */
    .emoji-float {
      position: fixed;
      font-size: 2em;
      pointer-events: none;
      animation: float 10s linear infinite;
      z-index: -1;
    }

    @keyframes float {
      0% { transform: translateY(100vh) translateX(0); opacity: 1; }
      100% { transform: translateY(-100vh) translateX(20px); opacity: 0; }
    }
  </style>
</head>
<body>
  <header>
    <div class="container header-content">
      <div class="logo">
        <i class="fas fa-comments"></i>
        <span>Mirindra Chat</span>
      </div>
      <div class="user-controls">
        <div class="user-avatar" id="user-avatar">
          <i class="fas fa-user"></i>
        </div>
        <span id="username-display">Invit√©</span>
      </div>
    </div>
  </header>

  <nav>
    <div class="container nav-container">
      <ul class="nav-tabs">
        <li class="nav-tab active" data-tab="chat">Discussion</li>
        <li class="nav-tab" data-tab="gallery">Galerie</li>
        <li class="nav-tab" data-tab="users">Utilisateurs</li>
        <li class="nav-tab" data-tab="about">√Ä propos</li>
      </ul>
      <div class="admin-controls" id="admin-controls" style="display: none;">
        <button class="btn btn-sm btn-outline" id="add-user-btn">
          <i class="fas fa-user-plus"></i> Ajouter utilisateur
        </button>
        <button class="btn btn-sm btn-danger" id="delete-selected-btn">
          <i class="fas fa-trash"></i> Supprimer s√©lection
        </button>
      </div>
    </div>
  </nav>

  <main class="container">
    <!-- Chat Tab -->
    <div class="tab-content active" id="chat-tab">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Discussion en direct</h2>
          <div id="online-count">0 utilisateurs en ligne</div>
        </div>
        <div id="chat-box"></div>
        <form id="chat-form">
          <div class="form-group">
            <label for="chat-message" class="form-label">Votre message</label>
            <div class="input-group">
              <input type="text" id="chat-message" class="form-control" placeholder="√âcrivez votre message ici..." required>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-paper-plane"></i> Envoyer
              </button>
            </div>
          </div>
          <div class="form-group">
            <label for="chat-image" class="form-label">Joindre une image</label>
            <input type="file" id="chat-image" class="form-control" accept="image/*">
          </div>
        </form>
      </div>
    </div>

    <!-- Gallery Tab -->
    <div class="tab-content" id="gallery-tab">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Galerie m√©dia</h2>
          <button class="btn btn-primary" id="upload-media-btn">
            <i class="fas fa-upload"></i> T√©l√©verser
          </button>
        </div>
        <div class="gallery" id="media-gallery"></div>
      </div>
    </div>

    <!-- Users Tab -->
    <div class="tab-content" id="users-tab">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Gestion des utilisateurs</h2>
        </div>
        <table class="users-table">
          <thead>
            <tr>
              <th><input type="checkbox" id="select-all-users"></th>
              <th>Utilisateur</th>
              <th>Email</th>
              <th>R√¥le</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="users-list">
            <!-- Users will be populated here -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- About Tab -->
    <div class="tab-content" id="about-tab">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">√Ä propos de Mirindra Chat</h2>
        </div>
        <div class="card-body">
          <p>Mirindra Chat est une plateforme de communication moderne d√©velopp√©e par <strong>Andrianarivelo Njara Mirindra Nirina</strong>.</p>
          <p>Cette application permet aux utilisateurs de :</p>
          <ul style="margin: 1rem 0 1rem 2rem;">
            <li>Communiquer en temps r√©el</li>
            <li>Partager des m√©dias (images, vid√©os)</li>
            <li>G√©rer un r√©seau d'utilisateurs</li>
            <li>Personnaliser leur exp√©rience</li>
          </ul>
          <p>Version: 2.0.0</p>
        </div>
      </div>
    </div>
  </main>

  <!-- Upload Media Modal -->
  <div class="modal" id="upload-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">T√©l√©verser un m√©dia</h3>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <form id="upload-form">
          <div class="form-group">
            <label for="media-file" class="form-label">Fichier m√©dia</label>
            <input type="file" id="media-file" class="form-control" accept="image/*,video/*" required>
          </div>
          <div class="form-group">
            <label for="media-description" class="form-label">Description (optionnel)</label>
            <textarea id="media-description" class="form-control" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary modal-close">Annuler</button>
        <button class="btn btn-primary" id="confirm-upload">T√©l√©verser</button>
      </div>
    </div>
  </div>

  <!-- Add User Modal -->
  <div class="modal" id="user-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="user-modal-title">Ajouter un utilisateur</h3>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <form id="user-form">
          <input type="hidden" id="user-id">
          <div class="form-group">
            <label for="user-name" class="form-label">Nom complet</label>
            <input type="text" id="user-name" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="user-email" class="form-label">Email</label>
            <input type="email" id="user-email" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="user-password" class="form-label">Mot de passe</label>
            <input type="password" id="user-password" class="form-control">
          </div>
          <div class="form-group">
            <label for="user-role" class="form-label">R√¥le</label>
            <select id="user-role" class="form-control" required>
              <option value="user">Utilisateur</option>
              <option value="moderator">Mod√©rateur</option>
              <option value="admin">Administrateur</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary modal-close">Annuler</button>
        <button class="btn btn-primary" id="confirm-user">Enregistrer</button>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div class="modal" id="login-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Connexion requise</h3>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <p>Vous devez vous connecter pour acc√©der √† cette fonctionnalit√©.</p>
        <div class="auth-buttons">
          <button class="btn auth-btn google" onclick="login('google')">
            <i class="fab fa-google"></i> Google
          </button>
          <button class="btn auth-btn facebook" onclick="login('facebook')">
            <i class="fab fa-facebook"></i> Facebook
          </button>
          <button class="btn auth-btn instagram" onclick="alert('Instagram doit √™tre simul√©, pas support√© par Firebase')">
            <i class="fab fa-instagram"></i> Instagram
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary modal-close">Fermer</button>
      </div>
    </div>
  </div>

  <!-- Emoji Float Animation -->
  <script>
    const emojis = ["üçï", "üçî", "üçü", "üåÆ", "üç£", "üéÇ", "üç©", "üçó", "üçá", "üçì", "ü•ë", "ü•ó", "ü•û"];
    setInterval(() => {
      const emoji = document.createElement("div");
      emoji.className = "emoji-float";
      emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
      emoji.style.left = Math.random() * 100 + "vw";
      emoji.style.animationDuration = 5 + Math.random() * 10 + "s";
      document.body.appendChild(emoji);
      setTimeout(() => emoji.remove(), 15000);
    }, 800);
  </script>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { 
      getFirestore, 
      collection, 
      addDoc, 
      query, 
      orderBy, 
      onSnapshot, 
      serverTimestamp,
      doc,
      updateDoc,
      deleteDoc,
      where,
      getDocs
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
    import { 
      getStorage, 
      ref, 
      uploadBytes, 
      getDownloadURL,
      deleteObject 
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js";
    import { 
      getAuth, 
      signInWithPopup, 
      GoogleAuthProvider, 
      FacebookAuthProvider,
      createUserWithEmailAndPassword,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAvajbCbTZ6826H0yIuz7S6MvvQ7sCec_M",
      authDomain: "mxrxndrv-discu.firebaseapp.com",
      projectId: "mxrxndrv-discu",
      storageBucket: "mxrxndrv-discu.appspot.com",
      messagingSenderId: "904395586988",
      appId: "1:904395586988:web:d790c830a7dc7feb3ace09",
      measurementId: "G-0GCH72QW09"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const auth = getAuth(app);

    // DOM Elements
    const chatForm = document.getElementById('chat-form');
    const chatBox = document.getElementById('chat-box');
    const uploadForm = document.getElementById('upload-form');
    const mediaGallery = document.getElementById('media-gallery');
    const usersList = document.getElementById('users-list');
    const userForm = document.getElementById('user-form');
    const addUserBtn = document.getElementById('add-user-btn');
    const deleteSelectedBtn = document.getElementById('delete-selected-btn');
    const selectAllUsers = document.getElementById('select-all-users');
    const uploadMediaBtn = document.getElementById('upload-media-btn');
    const confirmUploadBtn = document.getElementById('confirm-upload');
    const confirmUserBtn = document.getElementById('confirm-user');
    const userAvatar = document.getElementById('user-avatar');
    const usernameDisplay = document.getElementById('username-display');
    const adminControls = document.getElementById('admin-controls');
    const onlineCount = document.getElementById('online-count');

    // Modals
    const modals = document.querySelectorAll('.modal');
    const uploadModal = document.getElementById('upload-modal');
    const userModal = document.getElementById('user-modal');
    const loginModal = document.getElementById('login-modal');

    // Tab navigation
    const tabs = document.querySelectorAll('.nav-tab');
    const tabContents = document.querySelectorAll('.tab-content');

    // Current user data
    let currentUser = null;
    let isAdmin = false;

    // Initialize the app
    function initApp() {
      setupEventListeners();
      setupAuthStateListener();
      loadInitialData();
    }

    // Set up event listeners
    function setupEventListeners() {
      // Tab navigation
      tabs.forEach(tab => {
        tab.addEventListener('click', () => switchTab(tab.dataset.tab));
      });

      // Chat form submission
      chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!currentUser) {
          showLoginModal();
          return;
        }

        const message = document.getElementById('chat-message').value;
        const image = document.getElementById('chat-image').files[0];

        try {
          let imageUrl = null;
          if (image) {
            const storageRef = ref(storage, `chat/${currentUser.uid}/${Date.now()}_${image.name}`);
            await uploadBytes(storageRef, image);
            imageUrl = await getDownloadURL(storageRef);
          }

          await addDoc(collection(db, 'messages'), {
            userId: currentUser.uid,
            userName: currentUser.displayName || 'Anonyme',
            userPhoto: currentUser.photoURL || null,
            message: message,
            imageUrl: imageUrl,
            timestamp: serverTimestamp()
          });

          chatForm.reset();
        } catch (error) {
          console.error('Error sending message:', error);
          alert('Erreur lors de l\'envoi du message');
        }
      });

      // Upload media button
      uploadMediaBtn.addEventListener('click', () => {
        if (!currentUser) {
          showLoginModal();
          return;
        }
        uploadModal.style.display = 'flex';
      });

      // Confirm upload
      confirmUploadBtn.addEventListener('click', async () => {
        const file = document.getElementById('media-file').files[0];
        const description = document.getElementById('media-description').value;

        if (!file) {
          alert('Veuillez s√©lectionner un fichier');
          return;
        }

        try {
          const storageRef = ref(storage, `gallery/${currentUser.uid}/${Date.now()}_${file.name}`);
          await uploadBytes(storageRef, file);
          const url = await getDownloadURL(storageRef);

          await addDoc(collection(db, 'gallery'), {
            userId: currentUser.uid,
            userName: currentUser.displayName || 'Anonyme',
            userPhoto: currentUser.photoURL || null,
            url: url,
            description: description || '',
            type: file.type.startsWith('video') ? 'video' : 'image',
            timestamp: serverTimestamp()
          });

          uploadModal.style.display = 'none';
          document.getElementById('upload-form').reset();
        } catch (error) {
          console.error('Error uploading media:', error);
          alert('Erreur lors du t√©l√©versement du m√©dia');
        }
      });

      // Add user button
      addUserBtn.addEventListener('click', () => {
        if (!isAdmin) return;
        document.getElementById('user-modal-title').textContent = 'Ajouter un utilisateur';
        document.getElementById('user-id').value = '';
        document.getElementById('user-form').reset();
        userModal.style.display = 'flex';
      });

      // Confirm user action
      confirmUserBtn.addEventListener('click', async () => {
        const userId = document.getElementById('user-id').value;
        const name = document.getElementById('user-name').value;
        const email = document.getElementById('user-email').value;
        const password = document.getElementById('user-password').value;
        const role = document.getElementById('user-role').value;

        try {
          if (userId) {
            // Update existing user
            const userRef = doc(db, 'users', userId);
            await updateDoc(userRef, {
              name: name,
              email: email,
              role: role,
              updatedAt: serverTimestamp()
            });
          } else {
            // Create new user
            if (!password) {
              alert('Un mot de passe est requis pour la cr√©ation');
              return;
            }
            
            // Create auth user
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            
            // Add to users collection
            await addDoc(collection(db, 'users'), {
              uid: userCredential.user.uid,
              name: name,
              email: email,
              role: role,
              createdAt: serverTimestamp(),
              updatedAt: serverTimestamp()
            });
          }

          userModal.style.display = 'none';
        } catch (error) {
          console.error('Error managing user:', error);
          alert('Erreur lors de la gestion de l\'utilisateur');
        }
      });

      // Delete selected users
      deleteSelectedBtn.addEventListener('click', async () => {
        if (!isAdmin) return;
        
        const checkboxes = document.querySelectorAll('#users-list input[type="checkbox"]:checked');
        if (checkboxes.length === 0) {
          alert('Veuillez s√©lectionner au moins un utilisateur');
          return;
        }

        if (!confirm(`√ätes-vous s√ªr de vouloir supprimer ${checkboxes.length} utilisateur(s) ?`)) {
          return;
        }

        try {
          for (const checkbox of checkboxes) {
            const userId = checkbox.value;
            const userRef = doc(db, 'users', userId);
            await deleteDoc(userRef);
          }
        } catch (error) {
          console.error('Error deleting users:', error);
          alert('Erreur lors de la suppression des utilisateurs');
        }
      });

      // Select all users
      selectAllUsers.addEventListener('change', (e) => {
        const checkboxes = document.querySelectorAll('#users-list input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
          checkbox.checked = e.target.checked;
        });
      });

      // Modal close buttons
      document.querySelectorAll('.modal-close').forEach(button => {
        button.addEventListener('click', () => {
          modals.forEach(modal => modal.style.display = 'none');
        });
      });

      // Close modal when clicking outside
      modals.forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.style.display = 'none';
          }
        });
      });
    }

    // Set up auth state listener
    function setupAuthStateListener() {
      onAuthStateChanged(auth, async (user) => {
        currentUser = user;
        
        if (user) {
          // User is signed in
          usernameDisplay.textContent = user.displayName || user.email;
          
          if (user.photoURL) {
            userAvatar.innerHTML = `<img src="${user.photoURL}" alt="Avatar">`;
          } else {
            userAvatar.innerHTML = `<i class="fas fa-user"></i>`;
          }

          // Check if user is admin
          const usersRef = collection(db, 'users');
          const q = query(usersRef, where('uid', '==', user.uid));
          const querySnapshot = await getDocs(q);
          
          isAdmin = false;
          querySnapshot.forEach(doc => {
            if (doc.data().role === 'admin') {
              isAdmin = true;
            }
          });

          if (isAdmin) {
            adminControls.style.display = 'flex';
          } else {
            adminControls.style.display = 'none';
          }
        } else {
          // User is signed out
          usernameDisplay.textContent = 'Invit√©';
          userAvatar.innerHTML = `<i class="fas fa-user"></i>`;
          adminControls.style.display = 'none';
          isAdmin = false;
        }
      });
    }

    // Load initial data
    function loadInitialData() {
      // Load messages
      const messagesQuery = query(collection(db, 'messages'), orderBy('timestamp'));
      onSnapshot(messagesQuery, (snapshot) => {
        chatBox.innerHTML = '';
        snapshot.forEach(doc => {
          const message = doc.data();
          displayMessage(message);
        });
        chatBox.scrollTop = chatBox.scrollHeight;
      });

      // Load gallery
      const galleryQuery = query(collection(db, 'gallery'), orderBy('timestamp', 'desc'));
      onSnapshot(galleryQuery, (snapshot) => {
        mediaGallery.innerHTML = '';
        snapshot.forEach(doc => {
          const media = doc.data();
          displayMedia(media);
        });
      });

      // Load users
      const usersQuery = query(collection(db, 'users'), orderBy('createdAt', 'desc'));
      onSnapshot(usersQuery, (snapshot) => {
        usersList.innerHTML = '';
        snapshot.forEach(doc => {
          const user = { id: doc.id, ...doc.data() };
          displayUser(user);
        });
      });

      // Online users count (simplified)
      setInterval(() => {
        const count = Math.floor(Math.random() * 50) + 5; // Simulated count
        onlineCount.textContent = `${count} utilisateurs en ligne`;
      }, 5000);
    }

    // Display a message in the chat
    function displayMessage(message) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${message.userId === currentUser?.uid ? 'user' : ''}`;
      
      let messageHTML =
