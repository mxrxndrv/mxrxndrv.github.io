<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Messagerie Firebase</title>
  <style>
    /* Styles de base */
    #chat-box {
      border: 1px solid #ccc;
      height: 300px;
      overflow-y: scroll;
      padding: 10px;
      margin-bottom: 10px;
    }
    #dropZone {
      border: 2px dashed #ccc;
      padding: 20px;
      text-align: center;
      margin-bottom: 10px;
    }
    #dropZone.hover {
      border-color: #333;
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>

  <h1>Messagerie Firebase</h1>

  <div id="chat-box"></div>

  <form id="chat-form">
    <input type="text" id="username" placeholder="Votre nom" required />
    <input type="text" id="recipient" placeholder="Destinataire" required />
    <input type="text" id="message" placeholder="Votre message" required />
    <button type="submit">Envoyer</button>
  </form>

  <input type="file" id="fileInput" multiple />
  <div id="dropZone">Glissez vos fichiers ici</div>

  <!-- Inclusion des bibliothèques Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

  <script>
    // Configuration Firebase
    const firebaseConfig = {
      apiKey: "mxrxndrv756",
      authDomain: "mxrxndrv-messenger.mimi.com",
      projectId: "mxrxndrv-message",
      storageBucket: "mimi.com",
      messagingSenderId: "19215678",
      appId: "1:19215678:mimi:mxr12mi89"
    };

    // Initialisation de Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();
    const auth = firebase.auth();

    // Références aux éléments du DOM
    const chatBox = document.getElementById("chat-box");
    const chatForm = document.getElementById("chat-form");
    const usernameInput = document.getElementById("username");
    const recipientInput = document.getElementById("recipient");
    const messageInput = document.getElementById("message");
    const dropZone = document.getElementById("dropZone");
    const fileInput = document.getElementById("fileInput");

    // Envoi de message
    chatForm.addEventListener("submit", function(e) {
      e.preventDefault();
      const username = usernameInput.value;
      const recipient = recipientInput.value;
      const message = messageInput.value;

      db.collection("messages").add({
        username,
        recipient,
        message,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

      messageInput.value = "";
    });

    // Affichage des messages destinés à l'utilisateur
    const myUsername = "votre_nom_utilisateur"; // Remplacez par votre identifiant

    db.collection("messages")
      .where("recipient", "==", myUsername)
      .orderBy("timestamp")
      .onSnapshot(function(snapshot) {
        chatBox.innerHTML = "";
        snapshot.forEach(function(doc) {
          const data = doc.data();
          const div = document.createElement("div");
          div.textContent = `${data.username} : ${data.message}`;
          chatBox.appendChild(div);
        });
      });

    // Gestion du glisser-déposer de fichiers
    dropZone.addEventListener("dragover", (e) => {
      e.preventDefault();
      dropZone.classList.add("hover");
    });

    dropZone.addEventListener("dragleave", () => {
      dropZone.classList.remove("hover");
    });

    dropZone.addEventListener("drop", (e) => {
      e.preventDefault();
      dropZone.classList.remove("hover");
      const files = e.dataTransfer.files;
      handleFiles(files);
    });

    fileInput.addEventListener("change", (e) => {
      const files = e.target.files;
      handleFiles(files);
    });

    // Fonction de gestion des fichiers
    function handleFiles(files) {
      Array.from(files).forEach((file) => {
        const maxSize = 50 * 1024 * 1024; // 50 Mo
        if (file.size <= maxSize) {
          uploadFile(file);
        } else {
          const excessSize = file.size - maxSize;
          const excessMB = Math.ceil(excessSize / (10 * 1024 * 1024)) * 10;
          const paymentAmount = (excessMB / 10) * 500; // 500 Ar par 10 Mo

          alert(
            `Le fichier "${file.name}" dépasse la limite de 50 Mo.\n` +
            `Taille supplémentaire : ${excessMB} Mo\n` +
            `Montant à payer : ${paymentAmount} Ar\n` +
            `Veuillez effectuer le paiement via Mvola au numéro 0340894299.`
          );

          // Après confirmation du paiement, vous pouvez appeler uploadFile(file);
        }
      });
    }

    // Fonction de téléversement des fichiers vers Firebase Storage
    function uploadFile(file) {
      const storageRef = firebase.storage().ref();
      const fileRef = storageRef.child(`uploads/${file.name}`);
      fileRef.put(file).then(() => {
        alert(`Fichier "${file.name}" téléversé avec succès.`);
      }).catch((error) => {
        console.error("Erreur lors du téléversement :", error);
      });
    }
  </script>

</body>
</html>
